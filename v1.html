<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Encrypted - v1</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #000;
        color: #e0e0e0;
        min-height: 100vh;
        padding: 24px;
      }

      header {
        max-width: 600px;
        margin: 0 auto 60px;
        padding-bottom: 24px;
        border-bottom: 1px solid #1a1a1a;
      }

      header a {
        color: #e0e0e0;
        text-decoration: none;
        font-size: 20px;
        font-weight: 500;
        letter-spacing: 0.5px;
        transition: opacity 0.2s;
        font-family: "Courier New", monospace;
      }

      header a:hover {
        opacity: 0.7;
      }

      header a .bracket {
        color: #444;
      }

      header a .highlight {
        color: #fff;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
      }

      #app {
        max-width: 600px;
        margin: 0 auto;
      }

      /* Hide sections by default - will be shown via JS */
      #encrypt,
      #encrypt-create,
      #encrypt-success,
      #decrypt,
      #decrypt-locked,
      #decrypt-unlocked {
        display: none;
      }

      /* Show only the active state */
      #encrypt.active,
      #encrypt-create.active,
      #encrypt-success.active,
      #decrypt.active,
      #decrypt-locked.active,
      #decrypt-unlocked.active {
        display: block;
      }

      h1 {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 24px;
        letter-spacing: -1px;
        color: #fff;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      textarea {
        width: 100%;
        min-height: 200px;
        padding: 16px;
        background: #0a0a0a;
        border: 1px solid #2a2a2a;
        border-radius: 8px;
        color: #e0e0e0;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        font-size: 15px;
        line-height: 1.6;
        resize: vertical;
        transition: border-color 0.2s;
      }

      textarea:focus {
        outline: none;
        border-color: #444;
      }

      textarea::placeholder {
        color: #666;
      }

      input[type="text"],
      input[type="password"] {
        width: 100%;
        padding: 14px 16px;
        background: #0a0a0a;
        border: 1px solid #2a2a2a;
        border-radius: 8px;
        color: #e0e0e0;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        font-size: 15px;
        transition: border-color 0.2s;
      }

      input[type="text"]:focus,
      input[type="password"]:focus {
        outline: none;
        border-color: #444;
      }

      input[type="text"]::placeholder,
      input[type="password"]::placeholder {
        color: #666;
      }

      input[type="text"]:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }

      button {
        padding: 14px 24px;
        background: #fff;
        color: #000;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      }

      button:hover {
        opacity: 0.9;
      }

      button:active {
        opacity: 0.8;
      }

      .help-text {
        color: #999;
        font-size: 14px;
        margin-bottom: 8px;
      }

      .success-container {
        display: flex;
        gap: 12px;
      }

      .success-container input {
        flex: 1;
      }

      .success-container button {
        flex-shrink: 0;
      }

      #decrypt-locked-error {
        color: #ff6b6b;
        font-size: 14px;
        min-height: 20px;
      }

      #decrypt-unlocked-content {
        padding: 20px;
        background: #0a0a0a;
        border: 1px solid #2a2a2a;
        border-radius: 8px;
        color: #e0e0e0;
        font-size: 15px;
        line-height: 1.6;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      @media (max-width: 768px) {
        body {
          padding: 20px 16px;
        }

        header {
          margin-bottom: 40px;
        }

        h1 {
          font-size: 28px;
          margin-bottom: 20px;
        }

        textarea {
          min-height: 150px;
          font-size: 14px;
        }

        input[type="text"],
        input[type="password"] {
          font-size: 14px;
          padding: 12px 14px;
        }

        button {
          font-size: 14px;
          padding: 12px 20px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <a href="/"
        >en<span class="bracket">[</span><span class="highlight">crypt</span
        ><span class="bracket">]</span>ed</a
      >
    </header>

    <div id="app">
      <div id="encrypt">
        <div id="encrypt-create">
          <h1>Create encrypted note</h1>
          <form id="encrypt-create-form">
            <div>
              <div class="help-text">Your secret message</div>
              <textarea
                id="encrypt-create-text"
                placeholder="Enter your secret message here..."
              ></textarea>
            </div>
            <div>
              <div class="help-text">Password to encrypt with</div>
              <input
                id="encrypt-create-password"
                type="password"
                placeholder="Enter a strong password..."
              />
            </div>
            <button type="submit" id="encrypt-create-submit">
              Encrypt & Create Link
            </button>
          </form>
        </div>
        <div id="encrypt-success">
          <h1>Encrypted note created</h1>
          <div class="help-text">
            Share this link - the encrypted data is in the URL
          </div>
          <div class="success-container">
            <input
              type="text"
              disabled
              id="encrypt-success-url"
              value="https://example.com/v1.html#v1:ABC123..."
            />
            <button type="button" id="encrypt-success-copy">Copy Link</button>
          </div>
        </div>
      </div>
      <div id="decrypt">
        <div id="decrypt-locked">
          <h1>Unlock encrypted note</h1>
          <form id="decrypt-locked-form">
            <div>
              <div class="help-text">Enter the password to decrypt</div>
              <input
                id="decrypt-locked-password"
                type="password"
                placeholder="Enter password..."
              />
            </div>
            <button type="submit" id="decrypt-locked-submit">Decrypt</button>
            <div id="decrypt-locked-error"></div>
          </form>
        </div>
        <div id="decrypt-unlocked">
          <h1>Decrypted message</h1>
          <div id="decrypt-unlocked-content">
            This is where your decrypted message will appear...
          </div>
        </div>
      </div>
    </div>

    <script>
      // ==================== STATE MACHINE ====================
      const STATES = {
        ENCRYPT_CREATE: "encrypt-create",
        ENCRYPT_SUCCESS: "encrypt-success",
        DECRYPT_LOCKED: "decrypt-locked",
        DECRYPT_UNLOCKED: "decrypt-unlocked",
      };

      let currentState = null;

      function setState(newState) {
        // Remove active class from all sections
        document.querySelectorAll(".active").forEach((el) => {
          el.classList.remove("active");
        });

        currentState = newState;

        // Add active class to current state elements
        switch (newState) {
          case STATES.ENCRYPT_CREATE:
            document.getElementById("encrypt").classList.add("active");
            document.getElementById("encrypt-create").classList.add("active");
            break;
          case STATES.ENCRYPT_SUCCESS:
            document.getElementById("encrypt").classList.add("active");
            document.getElementById("encrypt-success").classList.add("active");
            break;
          case STATES.DECRYPT_LOCKED:
            document.getElementById("decrypt").classList.add("active");
            document.getElementById("decrypt-locked").classList.add("active");
            break;
          case STATES.DECRYPT_UNLOCKED:
            document.getElementById("decrypt").classList.add("active");
            document.getElementById("decrypt-unlocked").classList.add("active");
            break;
        }
      }

      function determineInitialState() {
        const hash = window.location.hash;

        if (hash && hash.startsWith("#v1:")) {
          return STATES.DECRYPT_LOCKED;
        } else {
          return STATES.ENCRYPT_CREATE;
        }
      }

      // ==================== CRYPTO UTILITIES ====================
      function assert(condition, message) {
        if (!condition) {
          throw new Error(message);
        }
      }

      function strToArrayBuffer(str) {
        const encoder = new TextEncoder();
        return encoder.encode(str);
      }

      function arrayBufferToString(buffer) {
        const decoder = new TextDecoder();
        return decoder.decode(buffer);
      }

      function arrayBufferToBase64(buffer) {
        return btoa(String.fromCharCode(...new Uint8Array(buffer)));
      }

      function base64ToArrayBuffer(base64) {
        const binary = atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
          bytes[i] = binary.charCodeAt(i);
        }
        return bytes.buffer;
      }

      async function deriveKey(password, salt) {
        const passwordKey = await crypto.subtle.importKey(
          "raw",
          strToArrayBuffer(password),
          "PBKDF2",
          false,
          ["deriveKey"],
        );

        return crypto.subtle.deriveKey(
          {
            name: "PBKDF2",
            salt: salt,
            iterations: 100000,
            hash: "SHA-256",
          },
          passwordKey,
          { name: "AES-GCM", length: 256 },
          false,
          ["encrypt", "decrypt"],
        );
      }

      async function encrypt(text, password) {
        assert(password, "Password is required");
        assert(text, "Text is required");
        assert(typeof text === "string", "Text must be a string");
        assert(typeof password === "string", "Password must be a string");

        try {
          const salt = crypto.getRandomValues(new Uint8Array(16));
          const iv = crypto.getRandomValues(new Uint8Array(12));
          const key = await deriveKey(password, salt);

          const encrypted = await crypto.subtle.encrypt(
            { name: "AES-GCM", iv: iv },
            key,
            strToArrayBuffer(text),
          );

          const combined = new Uint8Array(
            salt.length + iv.length + encrypted.byteLength,
          );
          combined.set(salt, 0);
          combined.set(iv, salt.length);
          combined.set(new Uint8Array(encrypted), salt.length + iv.length);

          return {
            ok: true,
            data: arrayBufferToBase64(combined.buffer),
          };
        } catch (error) {
          console.error("Encryption error:", error);
          return { ok: false, error: error.message };
        }
      }

      async function decrypt(encryptedData, password) {
        assert(password, "Password is required");
        assert(encryptedData, "Encrypted data is required");
        assert(
          typeof encryptedData === "string",
          "Encrypted data must be a string",
        );
        assert(typeof password === "string", "Password must be a string");

        try {
          const combined = new Uint8Array(base64ToArrayBuffer(encryptedData));

          const salt = combined.slice(0, 16);
          const iv = combined.slice(16, 28);
          const encrypted = combined.slice(28);

          const key = await deriveKey(password, salt);

          const decrypted = await crypto.subtle.decrypt(
            { name: "AES-GCM", iv: iv },
            key,
            encrypted,
          );

          return {
            ok: true,
            data: arrayBufferToString(decrypted),
          };
        } catch (error) {
          return { ok: false, error: error.message };
        }
      }

      // ==================== EVENT HANDLERS ====================
      async function handleEncryptSubmit(e) {
        e.preventDefault();

        const text = document.getElementById("encrypt-create-text").value;
        const password = document.getElementById(
          "encrypt-create-password",
        ).value;

        if (!text || !password) {
          alert("Please enter both a message and a password");
          return;
        }

        const result = await encrypt(text, password);

        if (result.ok) {
          const url = `${window.location.origin}${window.location.pathname}#v1:${result.data}`;
          document.getElementById("encrypt-success-url").value = url;
          // Don't navigate to the hash, just show the success state
          setState(STATES.ENCRYPT_SUCCESS);
        } else {
          alert(`Encryption failed: ${result.error}`);
        }
      }

      async function handleDecryptSubmit(e) {
        e.preventDefault();

        const password = document.getElementById(
          "decrypt-locked-password",
        ).value;
        const hash = window.location.hash;

        if (!password) {
          document.getElementById("decrypt-locked-error").textContent =
            "Please enter a password";
          return;
        }

        if (!hash || !hash.startsWith("#v1:")) {
          document.getElementById("decrypt-locked-error").textContent =
            "Invalid encrypted data in URL";
          return;
        }

        const encryptedData = hash.substring(4); // Remove "#v1:"
        const result = await decrypt(encryptedData, password);

        if (result.ok) {
          document.getElementById("decrypt-locked-error").textContent = "";
          document.getElementById("decrypt-unlocked-content").textContent =
            result.data;
          setState(STATES.DECRYPT_UNLOCKED);
        } else {
          document.getElementById("decrypt-locked-error").textContent =
            "Incorrect password or corrupted data";
        }
      }

      function handleCopyClick() {
        const urlInput = document.getElementById("encrypt-success-url");
        urlInput.select();
        navigator.clipboard.writeText(urlInput.value);

        const button = document.getElementById("encrypt-success-copy");
        const originalText = button.textContent;
        button.textContent = "Copied!";
        setTimeout(() => {
          button.textContent = originalText;
        }, 2000);
      }

      function handleHashChange() {
        const newState = determineInitialState();
        setState(newState);

        // Clear decrypt password and error when navigating back to decrypt
        if (newState === STATES.DECRYPT_LOCKED) {
          document.getElementById("decrypt-locked-password").value = "";
          document.getElementById("decrypt-locked-error").textContent = "";
        }
      }

      // ==================== INITIALIZATION ====================
      document.addEventListener("DOMContentLoaded", () => {
        // Wire up event listeners
        document
          .getElementById("encrypt-create-form")
          .addEventListener("submit", handleEncryptSubmit);

        document
          .getElementById("decrypt-locked-form")
          .addEventListener("submit", handleDecryptSubmit);

        document
          .getElementById("encrypt-success-copy")
          .addEventListener("click", handleCopyClick);

        window.addEventListener("hashchange", handleHashChange);

        // Set initial state
        setState(determineInitialState());
      });
    </script>
  </body>
</html>
