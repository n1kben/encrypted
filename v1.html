<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encrypted - v1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        header {
            max-width: 700px;
            margin: 0 auto 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header a {
            color: #e0e0e0;
            text-decoration: none;
            font-size: 18px;
            font-weight: 500;
            letter-spacing: 0.5px;
            transition: opacity 0.2s;
            font-family: 'Courier New', monospace;
        }

        header a:hover {
            opacity: 0.7;
        }

        header a .bracket {
            color: #666;
        }

        header a .highlight {
            color: #fff;
        }

        .version {
            color: #666;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
        }

        h1 {
            color: #fff;
            margin-bottom: 12px;
            font-size: 32px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .subtitle {
            color: #888;
            margin-bottom: 40px;
            font-size: 14px;
            line-height: 1.6;
        }

        label {
            display: block;
            margin-bottom: 10px;
            margin-top: 32px;
            color: #888;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        label:first-of-type {
            margin-top: 0;
        }

        input[type="password"] {
            width: 100%;
            padding: 14px 16px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 4px;
            font-size: 15px;
            color: #e0e0e0;
            transition: border-color 0.2s;
        }

        input[type="password"]:focus {
            outline: none;
            border-color: #fff;
        }

        input[type="password"]::placeholder {
            color: #555;
        }

        textarea {
            width: 100%;
            min-height: 300px;
            padding: 16px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 4px;
            font-size: 15px;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            resize: vertical;
            transition: border-color 0.2s;
            line-height: 1.6;
        }

        textarea:focus {
            outline: none;
            border-color: #fff;
        }

        textarea::placeholder {
            color: #555;
        }

        .decrypted-content {
            padding: 20px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 4px;
            font-size: 15px;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            line-height: 1.8;
            white-space: pre-wrap;
            word-break: break-word;
            min-height: 200px;
        }

        button {
            width: 100%;
            margin-top: 24px;
            padding: 14px 24px;
            background: #fff;
            color: #000;
            border: none;
            border-radius: 4px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        button:active {
            opacity: 0.7;
        }

        .info {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #222;
            color: #555;
            font-size: 12px;
            line-height: 1.6;
        }

        .url-length-warning {
            margin-top: 16px;
            padding: 12px 16px;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.5;
            display: none;
        }

        .url-length-warning.warning {
            background: #2a2a1a;
            border: 1px solid #3a3a2a;
            color: #ff7;
            display: block;
        }

        .url-length-warning.error {
            background: #2a1a1a;
            border: 1px solid #3a2a2a;
            color: #f88;
            display: block;
        }

        .decrypt-error {
            margin-top: 20px;
            padding: 16px;
            background: #2a1a1a;
            border: 1px solid #3a2a2a;
            border-radius: 4px;
            color: #f88;
            font-size: 14px;
        }

        .encrypted-url-container {
            margin-top: 24px;
            padding: 20px;
            background: #111;
            border: 1px solid #2a2a2a;
            border-radius: 4px;
            display: none;
        }

        .encrypted-url-container.show {
            display: block;
        }

        .encrypted-url-container h3 {
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .encrypted-url-box {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .encrypted-url-display {
            flex: 1;
            padding: 12px;
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #888;
            word-break: break-all;
            line-height: 1.6;
        }

        .url-length-badge {
            color: #666;
            font-size: 11px;
            margin-top: 4px;
        }

        .copy-url-btn {
            padding: 12px 20px;
            background: #fff;
            color: #000;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
            white-space: nowrap;
            margin-top: 0;
            width: auto;
        }

        .copy-url-btn:hover {
            opacity: 0.9;
        }

        .copy-url-btn.copied {
            background: #2a3a2a;
            color: #7f7;
        }

        .encrypted-url-info {
            color: #666;
            font-size: 12px;
            line-height: 1.5;
        }

        @media (max-width: 600px) {
            body {
                padding: 16px;
            }

            header {
                margin-bottom: 32px;
            }

            .encrypted-url-box {
                flex-direction: column;
            }

            .copy-url-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <a href="/">en<span class="bracket">[</span><span class="highlight">crypt</span><span class="bracket">]</span>ed</a>
        <span class="version">v1</span>
    </header>

    <div class="container">
        <div id="encryptMode">
            <h1>Create encrypted message</h1>
            <p class="subtitle">
                Enter your message and a password. Everything is encrypted client-side using AES-GCM.
            </p>

            <label for="content">Message</label>
            <textarea
                id="content"
                placeholder="Your message here..."
            ></textarea>

            <label for="password">Password</label>
            <input
                type="password"
                id="password"
                placeholder="Enter password"
                autocomplete="off"
            >

            <div id="urlLengthWarning" class="url-length-warning"></div>

            <button id="encryptBtn">Encrypt</button>

            <div id="encryptedUrlContainer" class="encrypted-url-container">
                <h3>Encrypted URL</h3>
                <div class="encrypted-url-box">
                    <div class="encrypted-url-display" id="encryptedUrlDisplay"></div>
                    <button class="copy-url-btn" id="copyUrlBtn">Copy</button>
                </div>
                <div class="encrypted-url-info">
                    Share this URL with your recipient. They'll need the password to decrypt it.
                </div>
            </div>

            <div class="info">
                The encrypted content is stored in the URL hash (#). The hash never leaves your browser—it's completely client-side.
            </div>
        </div>

        <div id="decryptMode" style="display: none;">
            <h1>Decrypt message</h1>
            <p class="subtitle">
                This URL contains an encrypted message. Enter the password to decrypt it.
            </p>

            <div id="decryptForm">
                <label for="decryptPassword">Password</label>
                <input
                    type="password"
                    id="decryptPassword"
                    placeholder="Enter password"
                    autocomplete="off"
                >

                <button id="decryptBtn">Decrypt</button>

                <div id="decryptError" class="decrypt-error" style="display: none;">
                    Wrong password. Please try again.
                </div>
            </div>

            <div id="decryptedContent" style="display: none;">
                <label>Decrypted Message</label>
                <div class="decrypted-content" id="decryptedText"></div>
            </div>

            <div class="info">
                All decryption happens in your browser. No data is transmitted—verify by checking the Network tab (F12).
            </div>
        </div>
    </div>

    <script>
        // Elements
        const encryptMode = document.getElementById('encryptMode');
        const decryptMode = document.getElementById('decryptMode');

        // Encrypt mode elements
        const passwordInput = document.getElementById('password');
        const contentTextarea = document.getElementById('content');
        const encryptBtn = document.getElementById('encryptBtn');
        const urlLengthWarning = document.getElementById('urlLengthWarning');
        const encryptedUrlContainer = document.getElementById('encryptedUrlContainer');
        const encryptedUrlDisplay = document.getElementById('encryptedUrlDisplay');
        const copyUrlBtn = document.getElementById('copyUrlBtn');

        // Decrypt mode elements
        const decryptForm = document.getElementById('decryptForm');
        const decryptPassword = document.getElementById('decryptPassword');
        const decryptBtn = document.getElementById('decryptBtn');
        const decryptError = document.getElementById('decryptError');
        const decryptedContent = document.getElementById('decryptedContent');
        const decryptedText = document.getElementById('decryptedText');

        // Convert string to ArrayBuffer
        function str2ab(str) {
            const encoder = new TextEncoder();
            return encoder.encode(str);
        }

        // Convert ArrayBuffer to string
        function ab2str(buffer) {
            const decoder = new TextDecoder();
            return decoder.decode(buffer);
        }

        // Convert ArrayBuffer to base64
        function ab2base64(buffer) {
            return btoa(String.fromCharCode(...new Uint8Array(buffer)));
        }

        // Convert base64 to ArrayBuffer
        function base642ab(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Derive encryption key from password
        async function deriveKey(password, salt) {
            const passwordKey = await crypto.subtle.importKey(
                'raw',
                str2ab(password),
                'PBKDF2',
                false,
                ['deriveKey']
            );

            return crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                passwordKey,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt', 'decrypt']
            );
        }

        // Encrypt content
        async function encrypt(text, password) {
            if (!password || !text) return null;

            try {
                const salt = crypto.getRandomValues(new Uint8Array(16));
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const key = await deriveKey(password, salt);

                const encrypted = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    str2ab(text)
                );

                // Combine salt + iv + encrypted data
                const combined = new Uint8Array(salt.length + iv.length + encrypted.byteLength);
                combined.set(salt, 0);
                combined.set(iv, salt.length);
                combined.set(new Uint8Array(encrypted), salt.length + iv.length);

                return ab2base64(combined.buffer);
            } catch (error) {
                console.error('Encryption error:', error);
                return null;
            }
        }

        // Decrypt content
        async function decrypt(encryptedData, password) {
            if (!password || !encryptedData) return null;

            try {
                const combined = new Uint8Array(base642ab(encryptedData));

                const salt = combined.slice(0, 16);
                const iv = combined.slice(16, 28);
                const encrypted = combined.slice(28);

                const key = await deriveKey(password, salt);

                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    encrypted
                );

                return ab2str(decrypted);
            } catch (error) {
                console.error('Decryption error:', error);
                return null;
            }
        }

        // Browser URL limits (in characters)
        const URL_LIMITS = {
            edge: 2083,
            chrome: 32779,
            firefox: 65536,
            safari: 80000
        };

        // Calculate estimated encrypted URL length
        function estimateEncryptedLength(text) {
            if (!text) return 0;

            // Base URL (current location without hash)
            const baseUrl = window.location.href.split('#')[0];

            // Encrypted data size:
            // - Salt: 16 bytes
            // - IV: 12 bytes
            // - Encrypted message: same size as input (UTF-8 encoded)
            // - Base64 encoding adds ~33% overhead
            const textBytes = new TextEncoder().encode(text).length;
            const encryptedBytes = 16 + 12 + textBytes;
            const base64Length = Math.ceil(encryptedBytes * 4 / 3);

            // Total URL length
            return baseUrl.length + 1 + base64Length; // +1 for '#'
        }

        // Check URL length and show warnings
        function checkUrlLength() {
            const text = contentTextarea.value;

            if (!text) {
                urlLengthWarning.className = 'url-length-warning';
                urlLengthWarning.textContent = '';
                return;
            }

            const estimatedLength = estimateEncryptedLength(text);

            if (estimatedLength > URL_LIMITS.chrome) {
                urlLengthWarning.className = 'url-length-warning error';
                urlLengthWarning.textContent = `⚠️ Message too long. Encrypted URL will be ~${estimatedLength.toLocaleString()} characters. Won't work in Chrome (limit: ${URL_LIMITS.chrome.toLocaleString()}), Firefox, or Safari.`;
            } else if (estimatedLength > URL_LIMITS.edge) {
                urlLengthWarning.className = 'url-length-warning warning';
                urlLengthWarning.textContent = `⚠️ Encrypted URL will be ~${estimatedLength.toLocaleString()} characters. Won't work in Microsoft Edge or Internet Explorer (limit: ${URL_LIMITS.edge.toLocaleString()}). Works in Chrome, Firefox, and Safari.`;
            } else {
                urlLengthWarning.className = 'url-length-warning';
                urlLengthWarning.textContent = '';
            }
        }

        // Determine which mode to show
        function updateMode() {
            const hasHash = window.location.hash.length > 1;

            if (hasHash) {
                // Decrypt mode
                encryptMode.style.display = 'none';
                decryptMode.style.display = 'block';
                decryptForm.style.display = 'block';
                decryptedContent.style.display = 'none';
                decryptError.style.display = 'none';
                decryptPassword.value = '';
                decryptedText.textContent = '';
            } else {
                // Encrypt mode
                encryptMode.style.display = 'block';
                decryptMode.style.display = 'none';
                passwordInput.value = '';
                contentTextarea.value = '';
                encryptedUrlContainer.classList.remove('show');
            }
        }

        // Truncate URL for display
        function truncateUrl(url) {
            const maxLength = 100; // Total characters to show (excluding "...")

            if (url.length <= maxLength) {
                return url;
            }

            // Split URL into base and hash
            const parts = url.split('#');
            const baseUrl = parts[0];
            const hash = parts[1] || '';

            // If base URL alone is too long, truncate it
            if (baseUrl.length > maxLength - 20) {
                return baseUrl.substring(0, maxLength - 20) + '...#' + hash.substring(0, 10) + '...' + hash.substring(hash.length - 10);
            }

            // Calculate how much hash to show
            const remainingSpace = maxLength - baseUrl.length - 1; // -1 for '#'
            const sideLength = Math.floor((remainingSpace - 3) / 2); // -3 for '...'

            if (sideLength < 10) {
                // Very short space, just show base URL and indicate there's a hash
                return baseUrl + '#...';
            }

            return baseUrl + '#' + hash.substring(0, sideLength) + '...' + hash.substring(hash.length - sideLength);
        }

        // Store full URL for copying
        let fullEncryptedUrl = '';

        // Event listeners
        encryptBtn.addEventListener('click', async () => {
            const password = passwordInput.value;
            const content = contentTextarea.value;

            if (!password || !content) {
                return;
            }

            const encrypted = await encrypt(content, password);
            if (encrypted) {
                // Generate the encrypted URL
                const baseUrl = window.location.href.split('#')[0];
                fullEncryptedUrl = `${baseUrl}#${encrypted}`;

                // Show truncated URL with length
                const truncated = truncateUrl(fullEncryptedUrl);
                encryptedUrlDisplay.innerHTML = `${truncated}<div class="url-length-badge">(${fullEncryptedUrl.length.toLocaleString()} characters)</div>`;
                encryptedUrlContainer.classList.add('show');

                // Reset copy button state
                copyUrlBtn.textContent = 'Copy';
                copyUrlBtn.classList.remove('copied');
            }
        });

        // Copy URL button
        copyUrlBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(fullEncryptedUrl);
                copyUrlBtn.textContent = 'Copied!';
                copyUrlBtn.classList.add('copied');

                // Reset after 2 seconds
                setTimeout(() => {
                    copyUrlBtn.textContent = 'Copy';
                    copyUrlBtn.classList.remove('copied');
                }, 2000);
            } catch (error) {
                console.error('Failed to copy:', error);
            }
        });

        decryptBtn.addEventListener('click', async () => {
            const hash = window.location.hash.slice(1);
            const password = decryptPassword.value;

            if (!password) {
                return;
            }

            // Hide any previous error
            decryptError.style.display = 'none';

            const decrypted = await decrypt(hash, password);
            if (decrypted) {
                // Success: hide form, show content
                decryptForm.style.display = 'none';
                decryptedContent.style.display = 'block';
                decryptedText.textContent = decrypted;
            } else {
                // Failure: show error
                decryptError.style.display = 'block';
            }
        });

        // Check URL length as user types and hide encrypted URL
        contentTextarea.addEventListener('input', () => {
            checkUrlLength();
            encryptedUrlContainer.classList.remove('show');
        });

        // Hide encrypted URL when password changes
        passwordInput.addEventListener('input', () => {
            encryptedUrlContainer.classList.remove('show');
        });

        // Handle Enter key for password inputs
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                encryptBtn.click();
            }
        });

        decryptPassword.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                decryptBtn.click();
            }
        });

        // Hide error when user starts typing again
        decryptPassword.addEventListener('input', () => {
            decryptError.style.display = 'none';
        });

        // Initialize mode on load
        window.addEventListener('load', updateMode);
        window.addEventListener('hashchange', updateMode);
    </script>
</body>
</html>
